<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>E-Kepegawaian | Monitoring KP & KGB2asdas2</title>

<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
body{
margin:0;
font-family:'Plus Jakarta Sans',sans-serif;
background:linear-gradient(180deg,#0a1e3b,#081225);
color:white;
}

.section{
min-height:100vh;
display:flex;
flex-direction:column;
justify-content:center;
align-items:center;
padding:20px;
}

.card{
background:rgba(255,255,255,0.08);
backdrop-filter:blur(16px);
padding:30px;
border-radius:25px;
box-shadow:0 10px 40px rgba(0,0,0,0.3);
width:100%;
max-width:500px;
}

input{
width:100%;
padding:14px;
border-radius:12px;
border:none;
margin-bottom:15px;
font-size:16px;
}

button{
padding:14px;
border:none;
border-radius:15px;
background:#d4a017;
color:white;
font-weight:700;
cursor:pointer;
width:100%;
font-size:16px;
}

button:hover{
opacity:0.9;
}

table{
width:100%;
border-collapse:collapse;
background:white;
color:black;
border-radius:15px;
overflow:hidden;
}

th,td{
padding:12px;
border-bottom:1px solid #eee;
font-size:14px;
}

th{
background:#111827;
color:white;
}

.hidden{
display:none;
}
</style>
</head>
<body>

<!-- LANDING -->
<div id="landingSection" class="section">

<h1 style="font-size:36px;margin-bottom:20px;">E-Kepegawaian</h1>

<div class="card">
<h3>Cek Status KP / KGB</h3>
<input type="number" id="nipInput" placeholder="Masukkan NIP">
<button onclick="cekNIP()">Cek Status</button>
<hr style="margin:20px 0;">
<button onclick="loginAdmin()">Login Admin</button>
</div>

</div>

<!-- UPLOAD -->
<div id="uploadSection" class="section hidden">

<h2>Upload Berkas</h2>
<p id="pegawaiInfo"></p>

<div class="card">
<input type="file" id="filePdf" accept="application/pdf">
<button onclick="unggahBerkas()">Kirim Berkas</button>
</div>

</div>

<!-- ADMIN -->
<div id="adminSection" class="section hidden">

<h2>Dashboard Admin</h2>
<br>
<table>
<thead>
<tr>
<th>NIP</th>
<th>Nama</th>
<th>Tipe</th>
<th>Periode</th>
<th>Status</th>
<th>Drive</th>
</tr>
</thead>
<tbody id="adminTableBody"></tbody>
</table>

<br>
<button onclick="location.reload()">Logout</button>

</div>

<script>

const GAS_URL = "https://script.google.com/macros/s/AKfycbwTh1Pr7MXU8F4NoZGBeAIU8jypjZA74QvAXCU69Io/exec";

let currentNip = "";

/* ========================
   UNIVERSAL GAS FETCH
======================== */
async function gasFetch(payload){
try{
const res = await fetch(GAS_URL,{
method:"POST",
headers:{
"Content-Type":"text/plain;charset=utf-8"
},
body:JSON.stringify(payload)
});

const text = await res.text();
console.log("RAW:",text);
return JSON.parse(text);

}catch(err){
console.error(err);
Swal.fire("Error","Gagal koneksi ke server","error");
throw err;
}
}

/* ========================
   CEK NIP
======================== */
async function cekNIP(){

const nip = document.getElementById("nipInput").value.trim();
if(!nip) return Swal.fire("Error","NIP wajib diisi","error");

Swal.fire({title:"Memverifikasi...",didOpen:()=>Swal.showLoading(),allowOutsideClick:false});

const data = await gasFetch({
func:"checkNIP",
nip:nip
});

Swal.close();

if(data.status==="success"){

currentNip = nip;

document.getElementById("landingSection").classList.add("hidden");
document.getElementById("uploadSection").classList.remove("hidden");

document.getElementById("pegawaiInfo").innerHTML = `
<b>${data.data.Nama}</b><br>
Tipe: ${data.data.Tipe_Pengajuan}<br>
Jatuh Tempo: ${data.data.Tgl_Periode}
`;

}else{
Swal.fire("Tidak ditemukan",data.message,"warning");
}

}

/* ========================
   UPLOAD
======================== */
async function unggahBerkas(){

const fileInput = document.getElementById("filePdf");
if(!fileInput.files[0]) return Swal.fire("Error","Pilih file dulu","error");

const file = fileInput.files[0];
const reader = new FileReader();

Swal.fire({title:"Uploading...",didOpen:()=>Swal.showLoading(),allowOutsideClick:false});

reader.onload = async e => {

const result = await gasFetch({
func:"processUpload",
payload:{
base64:e.target.result.split(",")[1],
type:file.type,
name:file.name,
nip:currentNip
}
});

Swal.close();

if(result==="Sukses"){
Swal.fire("Berhasil","Berkas terkirim","success").then(()=>location.reload());
}else{
Swal.fire("Gagal",result,"error");
}

};

reader.readAsDataURL(file);
}

/* ========================
   LOGIN ADMIN
======================== */
async function loginAdmin(){

const { value: formValues } = await Swal.fire({
title:"Login Admin",
html:`
<input id="u" class="swal2-input" placeholder="Username">
<input id="p" type="password" class="swal2-input" placeholder="Password">
`,
focusConfirm:false,
preConfirm:()=>[
document.getElementById("u").value,
document.getElementById("p").value
]
});

if(!formValues) return;

Swal.fire({title:"Verifikasi...",didOpen:()=>Swal.showLoading(),allowOutsideClick:false});

const result = await gasFetch({
func:"adminLogin",
u:formValues[0],
p:formValues[1]
});

Swal.close();

if(result===true){

document.getElementById("landingSection").classList.add("hidden");
document.getElementById("adminSection").classList.remove("hidden");

loadAdminData();

}else{
Swal.fire("Gagal","Username / Password salah","error");
}

}

/* ========================
   LOAD ADMIN DATA
======================== */
async function loadAdminData(){

const data = await gasFetch({
func:"getAdminData"
});

const tbody = document.getElementById("adminTableBody");
tbody.innerHTML="";

data.forEach(row=>{

tbody.innerHTML+=`
<tr>
<td>${row.NIP||"-"}</td>
<td>${row.Nama||"-"}</td>
<td>${row.Tipe_Pengajuan||"-"} ${row.isUrgent?'<b style="color:red;">(Urgent)</b>':''}</td>
<td>${row.Tgl_Periode||"-"}</td>
<td>${row.Status||"-"}</td>
<td>${row.Link_Drive?'<a href="'+row.Link_Drive+'" target="_blank">Buka</a>':'-'}</td>
</tr>
`;

});

}

</script>

</body>
</html>