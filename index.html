<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>E-Kepegawaian | Monitoring KP & KGB 2</title>
  <link rel="icon" type="image/png" href="https://example.com/logo-ekp.png"> <!-- Ganti logo -->
  <link rel="shortcut icon" type="image/png" href="https://example.com/logo-ekp.png">
  <link rel="apple-touch-icon" href="https://example.com/logo-ekp.png">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <style>
    body { font-family: 'Plus Jakarta Sans', sans-serif; scroll-behavior: smooth; }
    .hero-bg { background: linear-gradient(180deg, #0a1e3b 0%, #081225 100%); position: relative; min-height: 100vh; color: white; }
    .wave-bottom { position: absolute; bottom: 0; left: 0; width: 100%; line-height: 0; }
    .wave-bottom svg { position: relative; display: block; width: calc(100% + 1.3px); height: auto; }
    .wave-bottom .shape-fill { fill: #fafafa; }
    header { position: fixed; top: 0; left: 0; right: 0; z-index: 50; background: rgba(10, 30, 59, 0.9); backdrop-filter: blur(10px); transition: all 0.3s; }
    .header-container { display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem; max-width: 1400px; margin: 0 auto; }
    .btn-mulai-layanan { background-color: #d4a017; color: white; border: 2px solid white; padding: 0.75rem 2rem; border-radius: 0.75rem; font-weight: 800; text-transform: uppercase; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
    .btn-mulai-layanan:hover { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(212, 160, 23, 0.4); filter: brightness(1.1); }
    .glass-card { background: rgba(255, 255, 255, 0.08); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 1.5rem; padding: 2rem; box-shadow: 0 8px 32px rgba(0,0,0,0.37); }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #0a1e3b; }
    ::-webkit-scrollbar-thumb { background: #d4a017; border-radius: 10px; }
  </style>
</head>
<body class="bg-[#fafafa] text-slate-900 overflow-x-hidden">

  <!-- Hero / Landing -->
  <section id="landingSection" class="hero-bg flex flex-col justify-center items-center text-center px-6 relative">
    <header>
      <div class="header-container">
        <div class="flex items-center gap-3">
          <img src="https://example.com/logo-ekp.png" alt="Logo" class="h-10">
          <span class="text-xl font-bold text-white">E-Kepegawaian</span>
        </div>
        <button class="btn-mulai-layanan" onclick="loginAdmin()">
          Login Admin
        </button>
      </div>
    </header>

    <div class="mt-24 max-w-4xl">
      <h1 class="text-4xl md:text-6xl font-extrabold mb-6 leading-tight">
        Monitoring Kenaikan Pangkat & Gaji Pegawai
      </h1>
      <p class="text-xl md:text-2xl opacity-90 mb-10">
        Sistem cepat, aman, dan terintegrasi untuk pengajuan KP & KGB
      </p>

      <div class="glass-card max-w-lg mx-auto">
        <div class="mb-6">
          <label class="block text-sm font-semibold uppercase mb-2 text-gray-300">Nomor Induk Pegawai (NIP)</label>
          <input type="number" id="nipInput" placeholder="Masukkan NIP Anda" class="w-full px-5 py-4 bg-white/10 border border-white/20 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:border-[#d4a017] transition">
        </div>
        <button onclick="cekNIP()" class="btn-mulai-layanan w-full text-lg">
          Cek Status Saya
        </button>
      </div>
    </div>

    <div class="wave-bottom">
      <svg viewBox="0 0 1200 120" preserveAspectRatio="none">
        <path d="M0,0V46.29c47.79,22.2,103.59,32.17,158,28,70.36-5.37,136.33-33.31,206.8-37.5C438.64,32.43,512.34,53.67,583,72.05c69.27,18,138.3,24.88,209.4,13.08,36.15-6,69.85-17.84,104.45-29.34C989.49,25,1113-14.29,1200,52.47V0Z" opacity=".25" class="shape-fill"></path>
        <path d="M0,0V15.81C13,36.92,27.64,56.86,47.69,72.05,99.41,111.27,165,111,224.58,91.58c31.15-10.15,60.09-26.07,89.67-39.8,40.92-19,84.73-46,130.83-49.67,36.26-2.85,70.9,9.42,98.6,31.56,31.77,25.39,62.32,62,103.63,73,40.44,10.79,81.35-6.69,119.13-24.28s75.16-39,116.92-43.05c59.73-5.85,113.28,22.88,168.9,38.84,30.2,8.66,59,6.17,87.09-7.5,22.43-10.89,48-26.93,60.65-49.24V0Z" opacity=".25" class="shape-fill"></path>
        <path d="M0,0V5.63C149.93,59,314.09,71.32,475.83,42.57c43-7.64,84.23-20.12,127.61-26.46,59-8.63,112.48,12.24,165.56,35.4C827.93,77.22,886,95.24,951.2,90c86.53-7,172.46-45.71,248.8-84.81V0Z" class="shape-fill"></path>
      </svg>
    </div>
  </section>

  <!-- Upload Section -->
  <section id="uploadSection" class="py-20 bg-[#fafafa] hidden">
    <div class="container mx-auto px-6 text-center">
      <h2 class="text-4xl font-bold mb-8">Unggah Berkas Persyaratan</h2>
      <p id="pegawaiInfo" class="text-xl mb-10 font-semibold"></p>
      <div class="max-w-md mx-auto glass-card">
        <input type="file" id="filePdf" accept="application/pdf" class="mb-6 w-full text-white">
        <button onclick="unggahBerkas()" class="btn-mulai-layanan w-full">
          Kirim Berkas
        </button>
      </div>
    </div>
  </section>

  <!-- Admin Dashboard -->
  <section id="adminSection" class="py-20 bg-gray-100 hidden">
    <div class="container mx-auto px-6">
      <h2 class="text-4xl font-bold text-center mb-12">Dashboard Admin</h2>
      <div class="overflow-x-auto">
        <table id="adminTable" class="min-w-full bg-white shadow-md rounded-lg overflow-hidden">
          <thead class="bg-gray-800 text-white">
            <tr>
              <th class="px-6 py-3 text-left">NIP</th>
              <th class="px-6 py-3 text-left">Nama</th>
              <th class="px-6 py-3 text-left">Tipe</th>
              <th class="px-6 py-3 text-left">Periode</th>
              <th class="px-6 py-3 text-left">Status</th>
              <th class="px-6 py-3 text-left">Link Drive</th>
            </tr>
          </thead>
          <tbody id="adminTableBody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbwaauvkBPzKxy4ibOxO3ycelp2fQy9--VF-eLnf4-ELCvBPkdRRO79iZBOIOtorot97/exec';
    
let currentNip = "";

// Helper fetch wrapper
async function gasFetch(url, options = {}) {
  try {
    const res = await fetch(url, {
      ...options,
      redirect: 'follow',
      mode: 'cors',  // default, but explicit
      headers: {
        'Content-Type': 'text/plain;charset=utf-8',
        ...options.headers
      }
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return await res.json();
  } catch (err) {
    console.error('GAS fetch error:', err);
    throw err;
  }
}

async function cekNIP() {
  const nip = document.getElementById('nipInput').value.trim();
  if (!nip) return Swal.fire('Error', 'NIP tidak boleh kosong', 'error');

  Swal.fire({ title: 'Memverifikasi...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

  try {
    const data = await gasFetch(`${GAS_URL}?func=checkNIP&nip=${encodeURIComponent(nip)}`);
    Swal.close();

    if (data.status === "success") {
      currentNip = nip;
      document.getElementById('landingSection').classList.add('hidden');
      document.getElementById('uploadSection').classList.remove('hidden');
      document.getElementById('pegawaiInfo').innerHTML = `
        <strong>${data.data.Nama || 'N/A'}</strong><br>
        Tipe: ${data.data.Tipe_Pengajuan || '-'}<br>
        Jatuh Tempo: <b>${data.data.Tgl_Periode ? new Date(data.data.Tgl_Periode).toLocaleDateString('id-ID') : '-'}</b>
      `;
    } else {
      Swal.fire('Maaf', data.message || 'NIP tidak terdaftar', 'warning');
    }
  } catch (err) {
    Swal.close();
    Swal.fire('Error', 'Gagal koneksi server. Coba lagi nanti.', 'error');
  }
}

async function unggahBerkas() {
  const fileInput = document.getElementById('filePdf');
  if (!fileInput.files[0]) return Swal.fire('Error', 'Pilih file PDF dahulu', 'error');

  const file = fileInput.files[0];
  const reader = new FileReader();

  Swal.fire({ title: 'Mengunggah...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

  reader.onload = async e => {
    const payload = {
      func: 'processUpload',
      payload: {
        base64: e.target.result.split(',')[1],
        type: file.type,
        name: file.name,
        nip: currentNip
      }
    };

    try {
      const result = await gasFetch(GAS_URL, {
        method: 'POST',
        body: JSON.stringify(payload)
      });
      Swal.close();

      if (result === "Sukses") {
        Swal.fire('Sukses', 'Berkas berhasil dikirim!', 'success').then(() => location.reload());
      } else {
        Swal.fire('Gagal', result || 'Upload gagal', 'error');
      }
    } catch (err) {
      Swal.close();
      Swal.fire('Error', 'Gagal upload: ' + (err.message || 'Unknown error'), 'error');
    }
  };
  reader.readAsDataURL(file);
}

    async function loginAdmin() {
      const { value: formValues } = await Swal.fire({
        title: 'Login Admin',
        html: '<input id="u" class="swal2-input" placeholder="Username">' +
              '<input id="p" type="password" class="swal2-input" placeholder="Password">',
        focusConfirm: false,
        preConfirm: () => [document.getElementById('u').value, document.getElementById('p').value]
      });

      if (!formValues) return;

      Swal.fire({ title: 'Memverifikasi...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

      try {
        const res = await fetch(GAS_URL, {
          method: 'POST',
          redirect: 'follow',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({ func: 'adminLogin', u: formValues[0], p: formValues[1] })
        });
        const isOk = await res.json();

        Swal.close();

        if (isOk) {
          document.getElementById('landingSection').classList.add('hidden');
          document.getElementById('adminSection').classList.remove('hidden');
          renderAdminTable();
        } else {
          Swal.fire('Gagal', 'Username/Password salah', 'error');
        }
      } catch (err) {
        Swal.close();
        Swal.fire('Error', 'Gagal login: ' + err.message, 'error');
      }
    }

    async function renderAdminTable() {
      try {
        const res = await fetch(`${GAS_URL}?func=getAdminData`, { method: 'GET', redirect: 'follow' });
        const data = await res.json();

        const tbody = document.getElementById('adminTableBody');
        tbody.innerHTML = '';

        data.forEach(row => {
          const tr = document.createElement('tr');
          tr.classList.add('hover:bg-gray-50');
          tr.innerHTML = `
            <td class="px-6 py-4 border-t">${row.NIP || '-'}</td>
            <td class="px-6 py-4 border-t">${row.Nama || '-'}</td>
            <td class="px-6 py-4 border-t">${row.Tipe_Pengajuan || '-'} ${row.isUrgent ? '<span class="text-red-600 font-bold">(Urgent)</span>' : ''}</td>
            <td class="px-6 py-4 border-t">${row.Tgl_Periode ? new Date(row.Tgl_Periode).toLocaleDateString('id-ID') : '-'}</td>
            <td class="px-6 py-4 border-t">${row.Status || 'Proses Verifikasi'}</td>
            <td class="px-6 py-4 border-t">${row.Link_Drive ? `<a href="${row.Link_Drive}" target="_blank" class="text-blue-600 hover:underline">Buka</a>` : '-'}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        Swal.fire('Error', 'Gagal load data admin: ' + err.message, 'error');
      }
    }
  </script>
</body>
</html>